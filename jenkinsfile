pipeline {
    agent any

    environment {
        DEPLOY_USER = 'ec2-user'
        DEPLOY_HOST = '54.153.65.92'
        APP_DIR = '/home/ec2-user/node-app'
        REPO_URL = 'https://github.com/iamtruptimane/node-js-sample-jenkins.git'
    }

    stages {
        stage('Clone Code') {
            steps {
                git url: "${REPO_URL}", branch: 'master'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Deploy to Deployment Server') {
            steps {
                sshagent(['ssh-key']) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
                        echo "✅ Connected to deployment server"

                        # Create app directory if not exists
                        mkdir -p $APP_DIR
                        cd $APP_DIR

                        # Clone or pull latest code
                        if [ -d ".git" ]; then
                            git pull
                        else
                            git clone $REPO_URL . 
                        fi

                        # Install dependencies
                        npm install

                        # Start or restart the app with PM2
                        if pm2 list | grep -q "app"; then
                            pm2 restart app
                        else
                            pm2 start app.js --name app
                        fi

                        pm2 save
                        EOF
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '✅ Deployment succeeded.'
        }
        failure {
            echo '❌ Deployment failed. Check Jenkins logs.'
        }
    }
}
