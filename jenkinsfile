pipeline {
    agent any

    environment {
        DEPLOY_USER = 'ec2-user'
        DEPLOY_HOST = '54.153.65.92'
        APP_DIR = '/home/ec2-user/node-js-sample-jenkins'
        REPO_URL = 'https://github.com/iamtruptimane/node-js-sample-jenkins.git'
    }

    stages {
        stage('Clone Code') {
            steps {
                git url: "${REPO_URL}", branch: 'master'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }

        stage('Deploy to Deployment Server') {
            steps {
                sshagent(['ssh-key']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'EOF'
                            echo "✅ Connected to deployment server"

                            # Install pm2 if not present
                            which pm2 || sudo npm install -g pm2

                            # Clone the repo or update
                            if [ ! -d "${APP_DIR}" ]; then
                                git clone ${REPO_URL} ${APP_DIR}
                            fi

                            cd ${APP_DIR}
                            npm install

                            # Stop existing app and start again
                            pm2 stop all || true
                            pm2 start index.js --name app
                            pm2 save
                        EOF
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ Deployment succeeded.'
        }
        failure {
            echo '❌ Deployment failed. Check Jenkins logs.'
        }
    }
}
