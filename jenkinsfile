pipeline {
    agent any

    environment {
        DEPLOYMENT_SERVER_IP = '54.153.65.92'
        APP_DIR = '/home/ec2-user/node-js-app'
    }

    stages {

        stage('Clone Code') {
            steps {
                git url: 'https://github.com/iamtruptimane/node-js-sample-jenkins.git', branch: 'master'
            }
        }

        stage('Install Dependencies Locally') {
            steps {
                sh 'npm install'
            }
        }

        stage('Deploy to Deployment Server') {
            steps {
                sshagent(['ec2-user']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no ec2-user@${DEPLOYMENT_SERVER_IP} << 'EOF'
                      # Install Node.js if not installed
                      if ! command -v node &> /dev/null; then
                        curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
                        sudo yum install -y nodejs
                      fi

                      # Install pm2 if not installed
                      if ! command -v pm2 &> /dev/null; then
                        sudo npm install -g pm2
                      fi

                      # Prepare app directory
                      rm -rf ${APP_DIR}
                      git clone https://github.com/iamtruptimane/node-js-sample-jenkins.git ${APP_DIR}
                      cd ${APP_DIR}
                      npm install

                      # Restart app using pm2
                      pm2 stop all || true
                      pm2 start index.js --name node-app
                      pm2 save
                    EOF
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Deployment completed successfully!"
        }
        failure {
            echo "❌ Deployment failed. Check Jenkins logs."
        }
    }
}
