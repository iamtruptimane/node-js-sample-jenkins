pipeline {
    agent any

    environment {
        DEPLOY_USER = 'ubuntu'
        DEPLOY_HOST = '172.31.87.26'
        APP_DIR = '/home/ubuntu/node-js-sample-jenkins'
        REPO_URL = 'https://github.com/iamtruptimane/node-js-sample-jenkins.git'
    }

    stages {
        stage('Clone Code') {
            steps {
                echo 'üì• Cloning the repository on Jenkins agent...'
                git url: "${env.REPO_URL}", branch: 'master'
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'üì¶ Installing dependencies on Jenkins agent...'
                sh 'npm install'
            }
        }

        stage('Deploy to EC2 Server') {
            steps {
                echo 'üöÄ Starting deployment on remote EC2 instance...'

                sshagent(['node-key']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
                        #!/bin/bash
                        echo '‚úÖ Connected to remote server'

                        if ! command -v pm2 &> /dev/null
                        then
                            echo 'Installing PM2 globally...'
                            sudo npm install -g pm2
                        fi

                        if [ ! -d "${APP_DIR}" ]; then
                            echo 'Cloning repository...'
                            git clone ${REPO_URL} ${APP_DIR}
                        else
                            echo 'Repository already exists. Pulling latest changes...'
                            cd ${APP_DIR}
                            git pull origin master
                        fi

                        cd ${APP_DIR}
                        echo 'Installing application dependencies...'
                        npm install

                        echo 'Restarting application using PM2...'
                        pm2 stop app || true
                        pm2 start index.js --name app
                        pm2 save

                        echo '‚úÖ Deployment complete.'
                        ENDSSH
                    """
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ Deployment succeeded.'
        }
        failure {
            echo '‚ùå Deployment failed. Please check the logs for details.'
        }
    }
}
